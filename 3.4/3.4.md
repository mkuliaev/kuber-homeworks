# Домашнее задание к занятию «Обновление приложений»

### Цель задания

Выбрать и настроить стратегию обновления приложения.

### Чеклист готовности к домашнему заданию

1. Кластер K8s.

### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания

1. [Документация Updating a Deployment](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#updating-a-deployment).
2. [Статья про стратегии обновлений](https://habr.com/ru/companies/flant/articles/471620/).

-----

### Задание 1. Выбрать стратегию обновления приложения и описать ваш выбор

1. Имеется приложение, состоящее из нескольких реплик, которое требуется обновить.
2. Ресурсы, выделенные для приложения, ограничены, и нет возможности их увеличить.
3. Запас по ресурсам в менее загруженный момент времени составляет 20%.
4. Обновление мажорное, новые версии приложения не умеют работать со старыми.
5. Вам нужно объяснить свой выбор стратегии обновления приложения.

Учитывая всю серьезность нового обновления и отсутвие обратной совместимости хотелось бы использовать **Blue-green** деплой, чтобы можно было сначала протестировать стабильность работы новой версии. Хотя возможно это было проведено за рамками задания.

В условиях ограниченных ресурсов и малого допустимого времени простоя рекомендуется использовать **Rolling** стратегию, которая позволит постепенно заменить поды со старой версией на новые. 

Так же можно использовать **Reacreate** с убийством всех старых подов и заменой их на новую версию, но опять же возникает вопрос на сколько корректно будет работать обновленная версия приложения и не придется ли ее откатывать, получая в итоге простой сервиса.

### Задание 2. Обновить приложение

1. Создать deployment приложения с контейнерами nginx и multitool. Версию nginx взять 1.19. Количество реплик — 5.
```bash
kubectl describe deployment
Name:                   nginx-multitool
Namespace:              default
CreationTimestamp:      Wed, 24 Apr 2024 14:32:02 +0300
Labels:                 <none>
Annotations:            deployment.kubernetes.io/revision: 1
Selector:               app=ngmtool
Replicas:               5 desired | 5 updated | 5 total | 5 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=ngmtool
  Containers:
   nginx:
    Image:        nginx:1.19.0
    Port:         80/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:       <none>
   multitool:
    Image:       wbitt/network-multitool
    Ports:       8080/TCP, 11443/TCP
    Host Ports:  0/TCP, 0/TCP
    Environment:
      HTTP_PORT:   8080
      HTTPS_PORT:  11443
    Mounts:        <none>
  Volumes:         <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   nginx-multitool-6cb8d74bc6 (5/5 replicas created)
Events:          <none>
```
2. Обновить версию nginx в приложении до версии 1.20, сократив время обновления до минимума. Приложение должно быть доступно.

Ввиду необходимости доступности приложения обновляем по дефолтной **Rolling-стратегии**:
```bash
kubectl set image deployment.v1.apps/nginx-multitool nginx=nginx:1.20
deployment.apps/nginx-multitool image updated
```

```bash
kubectl get pods
NAME                               READY   STATUS              RESTARTS   AGE
nginx-multitool-6cb8d74bc6-22gtr   2/2     Running             0          26m
nginx-multitool-6cb8d74bc6-5rb5r   2/2     Running             0          26m
nginx-multitool-6cb8d74bc6-7b5gw   2/2     Running             0          26m
nginx-multitool-6cb8d74bc6-sl98t   2/2     Running             0          26m
nginx-multitool-7ffdc6559d-n8vq8   0/2     ContainerCreating   0          5s
nginx-multitool-7ffdc6559d-ppvsz   0/2     ContainerCreating   0          5s
nginx-multitool-7ffdc6559d-q7bb4   0/2     ContainerCreating   0          5s
```
```bash
kubectl exec nginx-multitool-7ffdc6559d-hb8cv  -- nginx -v
Defaulted container "nginx" out of: nginx, multitool
nginx version: nginx/1.20.2
```

Результат обновления на деплое:
```bash
kubectl describe deploy
Name:                   nginx-multitool
Namespace:              default
CreationTimestamp:      Wed, 24 Apr 2024 14:32:02 +0300
Labels:                 <none>
Annotations:            deployment.kubernetes.io/revision: 3
Selector:               app=ngmtool
Replicas:               5 desired | 5 updated | 5 total | 5 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=ngmtool
  Containers:
   nginx:
    Image:        nginx:1.20
    Port:         80/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:       <none>
   multitool:
    Image:       wbitt/network-multitool
    Ports:       8080/TCP, 11443/TCP
    Host Ports:  0/TCP, 0/TCP
    Environment:
      HTTP_PORT:   8080
      HTTPS_PORT:  11443
    Mounts:        <none>
  Volumes:         <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  nginx-multitool-6cb8d74bc6 (0/0 replicas created), nginx-multitool-6955c49dbf (0/0 replicas created)
NewReplicaSet:   nginx-multitool-7ffdc6559d (5/5 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  3m21s  deployment-controller  Scaled down replica set nginx-multitool-6cb8d74bc6 to 3 from 4
  Normal  ScalingReplicaSet  3m21s  deployment-controller  Scaled up replica set nginx-multitool-7ffdc6559d to 4 from 3
  Normal  ScalingReplicaSet  3m15s  deployment-controller  Scaled down replica set nginx-multitool-6cb8d74bc6 to 2 from 3
  Normal  ScalingReplicaSet  3m15s  deployment-controller  Scaled up replica set nginx-multitool-7ffdc6559d to 5 from 4
  Normal  ScalingReplicaSet  3m15s  deployment-controller  Scaled down replica set nginx-multitool-6cb8d74bc6 to 1 from 2
  Normal  ScalingReplicaSet  3m13s  deployment-controller  Scaled down replica set nginx-multitool-6cb8d74bc6 to 0 from 1
```

3. Попытаться обновить nginx до версии 1.28, приложение должно оставаться доступным.

Обновление до 1.28:
```bash
kubectl set image deployment/nginx-multitool nginx=nginx:1.28
deployment.apps/nginx-multitool image updated
```

Посмотреть статус деплоя:
```bash
kubectl rollout status deployment nginx-multitool
Waiting for deployment "nginx-multitool" rollout to finish: 3 out of 5 new replicas have been updated...
```

```bash
kubectl get pods
NAME                               READY   STATUS             RESTARTS   AGE
nginx-multitool-5595f9b8b6-4pfnf   1/2     ImagePullBackOff   0          21m
nginx-multitool-5595f9b8b6-87m5m   1/2     ImagePullBackOff   0          21m
nginx-multitool-5595f9b8b6-bzn9b   1/2     ImagePullBackOff   0          21m
nginx-multitool-7ffdc6559d-hb8cv   2/2     Running            0          31m
nginx-multitool-7ffdc6559d-n8vq8   2/2     Running            0          52m
nginx-multitool-7ffdc6559d-ppvsz   2/2     Running            0          52m
nginx-multitool-7ffdc6559d-q7bb4   2/2     Running            0          52m
```

```bash
kubectl describe deployment
Name:                   nginx-multitool
Namespace:              default
CreationTimestamp:      Wed, 24 Apr 2024 14:32:02 +0300
Labels:                 <none>
Annotations:            deployment.kubernetes.io/revision: 4
Selector:               app=ngmtool
Replicas:               5 desired | 3 updated | 7 total | 4 available | 3 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=ngmtool
  Containers:
   nginx:
    Image:        nginx:1.28
    Port:         80/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:       <none>
   multitool:
    Image:       wbitt/network-multitool
    Ports:       8080/TCP, 11443/TCP
    Host Ports:  0/TCP, 0/TCP
    Environment:
      HTTP_PORT:   8080
      HTTPS_PORT:  11443
    Mounts:        <none>
  Volumes:         <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    False   ProgressDeadlineExceeded
OldReplicaSets:  nginx-multitool-6cb8d74bc6 (0/0 replicas created), nginx-multitool-6955c49dbf (0/0 replicas created), nginx-multitool-7ffdc6559d (4/4 replicas created)
NewReplicaSet:   nginx-multitool-5595f9b8b6 (3/3 replicas created)
Events:          <none>
```
4. Откатиться после неудачного обновления.

Возврат на версию 1.20:
```bash
kubectl rollout undo deployment nginx-multitool
deployment.apps/nginx-multitool rolled back
```
```bash
kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
nginx-multitool-7ffdc6559d-hb8cv   2/2     Running   0          56m
nginx-multitool-7ffdc6559d-n8vq8   2/2     Running   0          78m
nginx-multitool-7ffdc6559d-ppvsz   2/2     Running   0          78m
nginx-multitool-7ffdc6559d-q7bb4   2/2     Running   0          78m
nginx-multitool-7ffdc6559d-s4fcs   2/2     Running   0          3s
```
```bash
kubectl describe deploy
Name:                   nginx-multitool
Namespace:              default
CreationTimestamp:      Wed, 24 Apr 2024 14:32:02 +0300
Labels:                 <none>
Annotations:            deployment.kubernetes.io/revision: 8
Selector:               app=ngmtool
Replicas:               5 desired | 5 updated | 5 total | 5 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=ngmtool
  Containers:
   nginx:
    Image:        nginx:1.20
    Port:         80/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:       <none>
   multitool:
    Image:       wbitt/network-multitool
    Ports:       8080/TCP, 11443/TCP
    Host Ports:  0/TCP, 0/TCP
    Environment:
      HTTP_PORT:   8080
      HTTPS_PORT:  11443
    Mounts:        <none>
  Volumes:         <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  nginx-multitool-6cb8d74bc6 (0/0 replicas created), nginx-multitool-6955c49dbf (0/0 replicas created), nginx-multitool-5595f9b8b6 (0/0 replicas created), nginx-multitool-575499684d (0/0 replicas created)
NewReplicaSet:   nginx-multitool-7ffdc6559d (5/5 replicas created)
Events:
  Type    Reason             Age                From                   Message
  ----    ------             ----               ----                   -------
  Normal  ScalingReplicaSet  26s (x3 over 57m)  deployment-controller  Scaled up replica set nginx-multitool-7ffdc6559d to 5 from 4
  Normal  ScalingReplicaSet  26s                deployment-controller  Scaled down replica set nginx-multitool-575499684d to 0 from 3
```

**Note**
---
Посмотреть набор реплик (ReplicaSet), созданный при деплое:
```bash
kubectl get rs
NAME                         DESIRED   CURRENT   READY   AGE
nginx-multitool-5595f9b8b6   0         0         0       34m
nginx-multitool-575499684d   3         3         0       10m
nginx-multitool-6955c49dbf   0         0         0       72m
nginx-multitool-6cb8d74bc6   0         0         0       92m
nginx-multitool-7ffdc6559d   4         4         4       66m
```
Посмотреть историю развертывания:
```bash
kubectl rollout history deployment nginx-multitool
deployment.apps/nginx-multitool 
REVISION  CHANGE-CAUSE
1         <none>
4         <none>
5         <none>
6         <none>
7         <none>
```
Посмотреть подробную информацию о каждой ревизии:
```bash
kubectl rollout history deployment/nginx-multitool --revision=7
deployment.apps/nginx-multitool with revision #7
Pod Template:
  Labels:	app=ngmtool
	pod-template-hash=575499684d
  Containers:
   nginx:
    Image:	nginx:1.28.0
    Port:	80/TCP
    Host Port:	0/TCP
    Environment:	<none>
    Mounts:	<none>
   multitool:
    Image:	wbitt/network-multitool
    Ports:	8080/TCP, 11443/TCP
    Host Ports:	0/TCP, 0/TCP
    Environment:
      HTTP_PORT:	8080
      HTTPS_PORT:	11443
    Mounts:	<none>
  Volumes:	<none>
```


## Дополнительные задания — со звёздочкой*

Задания дополнительные, необязательные к выполнению, они не повлияют на получение зачёта по домашнему заданию. **Но мы настоятельно рекомендуем вам выполнять все задания со звёздочкой.** Это поможет лучше разобраться в материале.   

### Задание 3*. Создать Canary deployment

1. Создать два deployment'а приложения nginx.
2. При помощи разных ConfigMap сделать две версии приложения — веб-страницы.
3. С помощью ingress создать канареечный деплоймент, чтобы можно было часть трафика перебросить на разные версии приложения.

### Правила приёма работы

1. Домашняя работа оформляется в своем Git-репозитории в файле README.md. Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.
2. Файл README.md должен содержать скриншоты вывода необходимых команд, а также скриншоты результатов.
3. Репозиторий должен содержать тексты манифестов или ссылки на них в файле README.md.
