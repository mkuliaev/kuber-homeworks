# Домашнее задание к занятию «Как работает сеть в K8s»

### Цель задания

Настроить сетевую политику доступа к подам.

### Чеклист готовности к домашнему заданию

1. Кластер K8s с установленным сетевым плагином Calico.

### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания

1. [Документация Calico](https://www.tigera.io/project-calico/).
2. [Network Policy](https://kubernetes.io/docs/concepts/services-networking/network-policies/).
3. [About Network Policy](https://docs.projectcalico.org/about/about-network-policy).

-----

### Задание 1. Создать сетевую политику или несколько политик для обеспечения доступа

1. Создать deployment'ы приложений frontend, backend и cache и соответсвующие сервисы.
2. В качестве образа использовать network-multitool.    

    [multitool-frontend](./frontend.yml)

    [multitool-backend](./backend.yml)
    
    [multitool-cache](./cache.yml)

3. Разместить поды в namespace App.

```bash
kubectl get namespace
NAME              STATUS   AGE
app               Active   7h9m
default           Active   6d6h
kube-node-lease   Active   6d6h
kube-public       Active   6d6h
kube-system       Active   6d6h
```

4. Создать политики, чтобы обеспечить доступ frontend -> backend -> cache. Другие виды подключений должны быть запрещены.

    [Дефолтная политика на запрет всего входящего трафика](./networkpolicy-default-deny-ingress.yml)

    [Разрешаем входящий трафик с frontend на backend](./networkpolicy-backend.yml)

    [Разрешаем входящий трафик с backend на cache](./networkpolicy-cache.yml)

5. Продемонстрировать, что трафик разрешён и запрещён.

Применение дефолтной политики:
```bash
kubectl -n app describe networkpolicy.networking.k8s.io default
Name:         default-deny-ingress
Namespace:    app
Created on:   2024-04-23 19:51:47 +0300 MSK
Labels:       <none>
Annotations:  <none>
Spec:
  PodSelector:     <none> (Allowing the specific traffic to all pods in this namespace)
  Allowing ingress traffic:
    <none> (Selected pods are isolated for ingress connectivity)
  Not affecting egress traffic
  Policy Types: Ingress
```

Применение политики на backend:
```bash
kubectl -n app describe networkpolicy.networking.k8s.io cache
Name:         cache-policy
Namespace:    app
Created on:   2024-04-23 19:51:37 +0300 MSK
Labels:       <none>
Annotations:  <none>
Spec:
  PodSelector:     app=cache
  Allowing ingress traffic:
    To Port: 80/TCP
    To Port: 443/TCP
    From:
      PodSelector: app=backend
  Not affecting egress traffic
  Policy Types: Ingress
```


Применение политики для cache: 
```bash
kubectl -n app describe networkpolicy.networking.k8s.io cache
Name:         cache-policy
Namespace:    app
Created on:   2024-04-23 19:51:37 +0300 MSK
Labels:       <none>
Annotations:  <none>
Spec:
  PodSelector:     app=cache
  Allowing ingress traffic:
    To Port: 80/TCP
    To Port: 443/TCP
    From:
      PodSelector: app=backend
  Not affecting egress traffic
  Policy Types: Ingress
```
Тестирование доступа через curl 

Разрешенный доступ:

frontend > backend
```bash
kubectl -n app exec multitool-front-578f985797-rnxqf curl multitool-back
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   146  100   146    0     0   206k      0 --:--:-- --:--:-- --:--:--  142k
WBITT Network MultiTool (with NGINX) - multitool-back-7bfd89b7c7-lgfrq - 10.1.152.8 - HTTP: 80 , HTTPS: 443 . (Formerly praqma/network-multitool)
```
backend > cache
```bash
kubectl -n app exec multitool-back-7bfd89b7c7-lgfrq curl multitool-cache
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   146  100   146    0     0   189k      0 --:--:-- --:--:-- --:--:--  142k
WBITT Network MultiTool (with NGINX) - multitool-cache-bd6c58d5f-9dqfz - 10.1.152.9 - HTTP: 80 , HTTPS: 443 . (Formerly praqma/network-multitool)
```

Запрещенный доступ:

front > cache
```bash
ols@x12:~/homeworks/kuber-homeworks/3.3$ kubectl -n app exec multitool-front-578f985797-rnxqf curl multitool-cache
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:--  0:00:05 --:--:--     0^C[A^[[A
```

back > front
```bash
kubectl -n app exec multitool-back-7bfd89b7c7-lgfrq curl multitool-front
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:--  0:00:02 --:--:--     0^C[A^[[A
```

cache > back
```bash
kubectl -n app exec multitool-cache-bd6c58d5f-9dqfz curl multitool-back
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:--  0:00:03 --:--:--     0^C
```

cache > front
```bash
kubectl -n app exec multitool-cache-bd6c58d5f-9dqfz curl multitool-front
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:--  0:00:14 --:--:--     0^C
```

### Правила приёма работы

1. Домашняя работа оформляется в своём Git-репозитории в файле README.md. Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.
2. Файл README.md должен содержать скриншоты вывода необходимых команд, а также скриншоты результатов.
3. Репозиторий должен содержать тексты манифестов или ссылки на них в файле README.md.
